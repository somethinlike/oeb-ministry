---
/**
 * AppLayout — wraps all authenticated /app/* pages.
 *
 * This layout:
 * 1. Inherits from BaseLayout (shared <head>, global styles)
 * 2. Adds a navigation header with user menu
 * 3. Checks auth client-side if the server couldn't read session cookies
 *
 * Auth is checked in two layers:
 * - Server: middleware tries to read session from cookies → Astro.locals.user
 * - Client: if server user is null, AuthGuard checks via browser Supabase client
 * - RLS: the real security — even if both layers fail, data is protected
 */
import BaseLayout from "./BaseLayout.astro";
import { AppNav } from "../components/AppNav";
import { ConnectionStatus } from "../components/ConnectionStatus";
import { UpdatePrompt } from "../components/UpdatePrompt";
import type { AuthState } from "../types/auth";

interface Props {
  title: string;
  /** When true, skip max-w-7xl container — used by workspace for full viewport */
  fullWidth?: boolean;
  /** When false, skip auth redirect — page is accessible without signing in.
   *  Default: true (redirects unauthenticated users to sign-in) */
  requireAuth?: boolean;
}

const { title, fullWidth = false, requireAuth = true } = Astro.props;
const user = Astro.locals.user;

// Build auth state from server data (may be null if cookies haven't synced)
const authState: AuthState | null = user
  ? {
      isAuthenticated: true,
      displayName: user.user_metadata?.full_name ?? user.email ?? "User",
      email: user.email ?? null,
      avatarUrl: user.user_metadata?.avatar_url ?? null,
      userId: user.id,
    }
  : null;
---

<BaseLayout title={title}>
  <!-- Offline/online status banner -->
  <ConnectionStatus client:load />

  <!-- Navigation header — uses server auth if available, placeholder if not -->
  <AppNav auth={authState ?? { isAuthenticated: false, displayName: null, email: null, avatarUrl: null, userId: null }} client:load />

  <!-- Page content — fullWidth skips max-width for workspace layout -->
  <div class={fullWidth ? "px-4 py-6 sm:px-6 lg:px-8" : "mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8"}>
    <slot />
  </div>

  <!-- PWA update notification -->
  <UpdatePrompt client:load />

  <!--
    Client-side auth check: if the server couldn't read the session
    from cookies, this script checks via the browser Supabase client
    and redirects to sign-in if the user is truly not authenticated.
  -->
  {!user && requireAuth && (
    <script>
      import { supabase } from "../lib/supabase";

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        const returnUrl = encodeURIComponent(window.location.pathname);
        window.location.href = `/auth/signin?returnUrl=${returnUrl}`;
      }
    </script>
  )}
</BaseLayout>
