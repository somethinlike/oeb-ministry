---
/**
 * OAuth callback handler (PKCE flow).
 *
 * After OAuth, Supabase redirects here with a `code` query parameter.
 * We exchange the code for a session server-side, which sets the auth
 * cookies, then redirect the user to the app.
 *
 * Why server-side? @supabase/ssr uses PKCE by default, which sends
 * an authorization code (not hash tokens). The code must be exchanged
 * via the Supabase API for a session. Doing this server-side means
 * the session cookies are set immediately — no client-side JS needed.
 */
import { createSupabaseServerClient } from "../../lib/supabase-server";

const code = Astro.url.searchParams.get("code");
const returnUrl = Astro.url.searchParams.get("returnUrl") || "/app/read";

if (code) {
  // Exchange the authorization code for a session.
  // This sets auth cookies via the server client's cookie handler.
  const supabase = createSupabaseServerClient(
    Astro.cookies,
    Astro.request.headers.get("cookie"),
  );
  const { error } = await supabase.auth.exchangeCodeForSession(code);

  if (!error) {
    // Session established — send user to where they were going
    return Astro.redirect(returnUrl);
  }

  // Code exchange failed — send to sign-in with error context
  console.error("OAuth code exchange failed:", error.message);
  return Astro.redirect("/auth/signin?error=auth_failed");
}

// No code in URL — shouldn't happen in normal flow.
// Redirect to sign-in as a safe fallback.
return Astro.redirect("/auth/signin");
---
