---
/**
 * OAuth callback handler.
 *
 * After OAuth, Supabase redirects here with auth tokens in the URL
 * hash fragment (implicit flow). The browser Supabase client auto-detects
 * these tokens and sets the session in cookies.
 *
 * This page shows "Signing you in..." while the client processes
 * the tokens, then redirects to the app.
 */
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout title="Signing you in...">
  <div class="flex min-h-screen items-center justify-center bg-gray-50 px-4">
    <div class="text-center">
      <p class="text-lg text-gray-600">Signing you in...</p>
    </div>
  </div>

  <script>
    import { supabase } from "../../lib/supabase";

    const params = new URLSearchParams(window.location.search);
    const returnUrl = params.get("returnUrl") || "/app/read";

    // Check if the browser client already has a session
    // (tokens auto-detected from URL hash by createBrowserClient)
    const { data } = await supabase.auth.getSession();

    if (data.session) {
      window.location.href = returnUrl;
    } else {
      // Listen for the session to be set (may take a moment)
      const { data: { subscription } } = supabase.auth.onAuthStateChange(
        (event) => {
          if (event === "SIGNED_IN") {
            subscription.unsubscribe();
            window.location.href = returnUrl;
          }
        }
      );

      // If nothing happens after 5 seconds, send back to sign-in
      setTimeout(() => {
        subscription.unsubscribe();
        supabase.auth.getSession().then(({ data }) => {
          if (data.session) {
            window.location.href = returnUrl;
          } else {
            window.location.href = "/auth/signin?error=callback_timeout";
          }
        });
      }, 5000);
    }
  </script>
</BaseLayout>
