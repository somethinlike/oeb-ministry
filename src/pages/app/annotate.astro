---
/**
 * Annotation page â€” create or edit a note for specific verses.
 *
 * URL params:
 * - t: translation
 * - b: book
 * - c: chapter
 * - vs: verse start
 * - ve: verse end
 * - id: (optional) annotation ID for editing
 */
import AppLayout from "../../layouts/AppLayout.astro";
import { AnnotationPanel } from "../../components/AnnotationPanel";
import { getAnnotation } from "../../lib/annotations";
import type { Annotation } from "../../types/annotation";

const user = Astro.locals.user;

// If auth cookies haven't synced yet, the client-side guard in AppLayout
// will handle the redirect. But we can't render without a userId, so bail.
if (!user) {
  return Astro.redirect(`/auth/signin?returnUrl=${encodeURIComponent(Astro.url.pathname + Astro.url.search)}`);
}

// Parse URL params
const translation = Astro.url.searchParams.get("t") || "";
const book = Astro.url.searchParams.get("b") || "";
const chapter = parseInt(Astro.url.searchParams.get("c") || "0", 10);
const verseStart = parseInt(Astro.url.searchParams.get("vs") || "0", 10);
const verseEnd = parseInt(Astro.url.searchParams.get("ve") || "0", 10);

// Validate required params
if (!translation || !book || !chapter || !verseStart || !verseEnd) {
  return Astro.redirect("/app/read");
}

// Check for existing annotation to edit
const annotationId = Astro.url.searchParams.get("id");
let existing: Annotation | null = null;

if (annotationId) {
  existing = await getAnnotation(Astro.locals.supabase, annotationId);
}
---

<AppLayout title="Write a Note">
  <div class="mx-auto max-w-2xl">
    <a
      href={`/app/read/${translation}/${book}/${chapter}`}
      class="mb-6 inline-flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700
             focus:outline-none focus:ring-2 focus:ring-blue-500 rounded"
    >
      &larr; Back to reading
    </a>

    <AnnotationPanel
      userId={user.id}
      translation={translation}
      book={book}
      chapter={chapter}
      verseStart={verseStart}
      verseEnd={verseEnd}
      existing={existing}
      client:load
    />
  </div>
</AppLayout>
