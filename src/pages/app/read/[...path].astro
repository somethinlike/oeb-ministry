---
/**
 * Bible reader — dynamic route that handles all reading paths:
 *
 * /app/read                    → translation picker grid
 * /app/read/oeb-us             → book picker for OEB
 * /app/read/oeb-us/jhn         → chapter picker for John
 * /app/read/oeb-us/jhn/3       → workspace: split-pane reader + annotations
 *
 * Uses Astro's [...path] catch-all route to handle all depths.
 */
import AppLayout from "../../../layouts/AppLayout.astro";
import { BookPicker } from "../../../components/BookPicker";
import { ChapterPicker } from "../../../components/ChapterPicker";
import { Workspace } from "../../../components/workspace";
import { SUPPORTED_TRANSLATIONS, DEFAULT_TRANSLATION, BOOK_BY_ID } from "../../../lib/constants";
import { isValidBookId } from "../../../lib/verse-ref";

// Parse the URL path segments
const pathStr = Astro.params.path || "";
const segments = pathStr ? pathStr.split("/") : [];

// ── Determine which view to render based on URL depth ──

let view: "translation" | "book" | "chapter" | "read" = "translation";
let translation = "";
let book = "";
let chapter = 0;

if (segments.length === 0) {
  // /app/read → show translation picker (no more auto-redirect!)
  view = "translation";
}

if (segments.length >= 1) {
  translation = segments[0];
  // Validate translation exists
  const validTranslation = SUPPORTED_TRANSLATIONS.some(t => t.id === translation);
  if (!validTranslation) {
    return Astro.redirect(`/app/read`);
  }
  view = "book";
}

if (segments.length >= 2) {
  book = segments[1];
  if (!isValidBookId(book)) {
    return Astro.redirect(`/app/read/${translation}`);
  }
  view = "chapter";
}

if (segments.length >= 3) {
  chapter = parseInt(segments[2], 10);
  const bookInfo = BOOK_BY_ID.get(book as any);
  if (!bookInfo || isNaN(chapter) || chapter < 1 || chapter > bookInfo.chapters) {
    return Astro.redirect(`/app/read/${translation}/${book}`);
  }
  view = "read";
}

// Page titles that make sense to the user
const titles: Record<string, string> = {
  translation: "Choose a Bible",
  book: "Choose a Book",
  chapter: `${BOOK_BY_ID.get(book as any)?.name ?? book} — Choose a Chapter`,
  read: `${BOOK_BY_ID.get(book as any)?.name ?? book} ${chapter}`,
};

// Get user for workspace (may be null if auth cookies haven't synced)
const user = Astro.locals.user;
---

<AppLayout title={titles[view]} fullWidth={view === "read"}>
  {/* Translation picker grid — shows all available Bibles */}
  {view === "translation" && (
    <div>
      <h1 class="text-2xl font-bold text-gray-900 mb-6">Choose a Bible</h1>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {SUPPORTED_TRANSLATIONS.map((t) => (
          <a
            href={`/app/read/${t.id}`}
            class="rounded-lg border border-gray-200 bg-white p-6
                   hover:border-blue-300 hover:bg-blue-50
                   focus:outline-none focus:ring-2 focus:ring-blue-500
                   transition-colors duration-150"
          >
            <h2 class="text-lg font-semibold text-gray-900">{t.name}</h2>
            <p class="text-sm text-gray-500 mt-1">{t.license}</p>
            {t.hasApocrypha && (
              <span class="mt-2 inline-block rounded-full bg-purple-100 px-2.5 py-0.5 text-xs font-medium text-purple-700">
                Includes Deuterocanon
              </span>
            )}
          </a>
        ))}
      </div>
    </div>
  )}

  {/* Breadcrumb navigation — for non-workspace views */}
  {(view === "book" || view === "chapter") && (
    <nav aria-label="Breadcrumb" class="mb-6">
      <ol class="flex flex-wrap items-center gap-2 text-sm text-gray-500">
        <li>
          <a href="/app/read" class="hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded">
            Bible
          </a>
        </li>
        <li class="flex items-center gap-2">
          <span aria-hidden="true">/</span>
          <a href={`/app/read/${translation}`} class="hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded">
            {SUPPORTED_TRANSLATIONS.find(t => t.id === translation)?.name ?? translation}
          </a>
        </li>
        {view === "chapter" && (
          <li class="flex items-center gap-2">
            <span aria-hidden="true">/</span>
            <span class="font-medium text-gray-900">
              {BOOK_BY_ID.get(book as any)?.name ?? book}
            </span>
          </li>
        )}
      </ol>
    </nav>
  )}

  {/* View-specific content */}
  {view === "book" && (
    <BookPicker translation={translation} client:load />
  )}

  {view === "chapter" && (
    <ChapterPicker translation={translation} book={book} client:load />
  )}

  {/* Workspace: split-pane reader + annotations */}
  {view === "read" && (
    <Workspace
      translation={translation}
      book={book}
      chapter={chapter}
      userId={user?.id ?? null}
      client:load
    />
  )}
</AppLayout>
